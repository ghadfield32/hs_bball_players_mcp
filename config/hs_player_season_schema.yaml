# High School Player Season Statistics - Canonical Schema
# Version: 1.0
# Last Updated: 2025-11-16
#
# This schema defines the canonical format for all high school basketball player
# season statistics across all datasources. Every backfill script must output
# data conforming to this schema.
#
# Purpose: Enable downstream forecasting models to consume HS stats without caring
# about the original data source.

# ==============================================================================
# REQUIRED FIELDS - Must be present in all exports
# ==============================================================================

required_fields:
  # ---------------------------------------------------------------------------
  # Identifiers (Primary Keys)
  # ---------------------------------------------------------------------------

  global_player_id:
    type: string
    description: "Internal UUID for player entity resolution across sources"
    example: "hs_player_abc123"
    notes: "Generated by entity resolution system. May be source_player_id initially."

  source:
    type: string
    description: "Datasource name (eybl, sblive, osba, fiba_youth, etc.)"
    example: "eybl"
    allowed_values: ["eybl", "sblive", "osba", "3ssb", "uaa", "fiba_youth", "angt", "mn_hub", "state_association"]

  source_player_id:
    type: string
    description: "Original player ID from datasource (eybl_john_doe, sblive_wa_jane_smith)"
    example: "eybl_cooper_flagg"
    notes: "Must be unique within source. Used for entity resolution."

  season:
    type: string
    description: "Season identifier (YYYY or YYYY-YY format)"
    example: "2024"
    examples: ["2024", "2024-25", "2023-24"]
    notes: "Use YYYY for calendar year circuits (EYBL), YYYY-YY for school years (SBLive)"

  # ---------------------------------------------------------------------------
  # Player Metadata
  # ---------------------------------------------------------------------------

  first_name:
    type: string
    description: "Player first name"
    example: "Cooper"
    nullable: true
    notes: "May be null if source only provides full name"

  last_name:
    type: string
    description: "Player last name"
    example: "Flagg"
    nullable: true

  full_name:
    type: string
    description: "Player full name (combined or as provided by source)"
    example: "Cooper Flagg"
    nullable: false
    notes: "Always populated. If first/last unavailable, use this."

  # ---------------------------------------------------------------------------
  # Context Fields (League/Team/Location)
  # ---------------------------------------------------------------------------

  league:
    type: string
    description: "League or circuit name"
    example: "Nike EYBL"
    examples: ["Nike EYBL", "SBLive Washington", "OSBA U19", "FIBA U17 World Cup"]
    nullable: false

  team_id:
    type: string
    description: "Team identifier (source-specific)"
    example: "eybl_team_maine_united"
    nullable: true

  team_name:
    type: string
    description: "Team/club name"
    example: "Maine United"
    nullable: false

  state_code:
    type: string
    description: "US state code (ISO 3166-2) or 'INTL' for international"
    example: "WA"
    examples: ["WA", "CA", "TX", "FL", "ON", "INTL"]
    nullable: true
    notes: "Use 2-letter state codes for US, province codes for Canada, 'INTL' for international"

  country_code:
    type: string
    description: "ISO 3166-1 alpha-2 country code"
    example: "US"
    examples: ["US", "CA", "FR", "ES"]
    nullable: true
    default: "US"

  # ---------------------------------------------------------------------------
  # Core Counting Stats (Required - use 0 if not available)
  # ---------------------------------------------------------------------------

  games_played:
    type: integer
    description: "Games played"
    example: 18
    nullable: false
    validation: ">= 0"

  games_started:
    type: integer
    description: "Games started"
    example: 15
    nullable: true
    validation: ">= 0 AND <= games_played"

  minutes:
    type: float
    description: "Total minutes played (or average if that's what source provides)"
    example: 540.5
    nullable: true
    validation: ">= 0"
    notes: "If source provides MPG, store as-is and note in per_game_stats field"

  # Shooting Stats
  field_goals_made:
    type: integer
    description: "Field goals made (2PT + 3PT)"
    example: 150
    nullable: true
    validation: ">= 0"

  field_goals_attempted:
    type: integer
    description: "Field goals attempted"
    example: 280
    nullable: true
    validation: ">= field_goals_made"

  three_pointers_made:
    type: integer
    description: "Three-pointers made"
    example: 42
    nullable: true
    validation: ">= 0"

  three_pointers_attempted:
    type: integer
    description: "Three-pointers attempted"
    example: 120
    nullable: true
    validation: ">= three_pointers_made"

  free_throws_made:
    type: integer
    description: "Free throws made"
    example: 85
    nullable: true
    validation: ">= 0"

  free_throws_attempted:
    type: integer
    description: "Free throws attempted"
    example: 110
    nullable: true
    validation: ">= free_throws_made"

  # Rebounding
  offensive_rebounds:
    type: integer
    description: "Offensive rebounds"
    example: 45
    nullable: true
    validation: ">= 0"

  defensive_rebounds:
    type: integer
    description: "Defensive rebounds"
    example: 135
    nullable: true
    validation: ">= 0"

  total_rebounds:
    type: integer
    description: "Total rebounds (OREB + DREB, or total if split unavailable)"
    example: 180
    nullable: true
    validation: ">= 0"
    notes: "If OREB/DREB unavailable, store total here"

  # Other Stats
  assists:
    type: integer
    description: "Assists"
    example: 72
    nullable: true
    validation: ">= 0"

  steals:
    type: integer
    description: "Steals"
    example: 34
    nullable: true
    validation: ">= 0"

  blocks:
    type: integer
    description: "Blocks"
    example: 28
    nullable: true
    validation: ">= 0"

  turnovers:
    type: integer
    description: "Turnovers"
    example: 56
    nullable: true
    validation: ">= 0"

  personal_fouls:
    type: integer
    description: "Personal fouls"
    example: 42
    nullable: true
    validation: ">= 0"

  points:
    type: integer
    description: "Total points (or average if that's what source provides)"
    example: 427
    nullable: false
    validation: ">= 0"
    notes: "If source provides PPG, store as-is and note in per_game_stats field"

# ==============================================================================
# OPTIONAL FIELDS - Include if available from source
# ==============================================================================

optional_fields:
  # ---------------------------------------------------------------------------
  # Player Attributes
  # ---------------------------------------------------------------------------

  position:
    type: string
    description: "Position (PG/SG/SF/PF/C or combinations)"
    example: "SF"
    examples: ["PG", "SG", "SF", "PF", "C", "G", "F", "G/F", "F/C"]
    nullable: true

  jersey_number:
    type: integer
    description: "Jersey number"
    example: 23
    nullable: true

  height_inches:
    type: integer
    description: "Height in inches"
    example: 79
    nullable: true
    notes: "6'7\" = 79 inches"

  weight_lbs:
    type: integer
    description: "Weight in pounds"
    example: 205
    nullable: true

  graduation_year:
    type: integer
    description: "High school graduation year (class of YYYY)"
    example: 2025
    nullable: true
    notes: "Use for age/grade inference"

  grade:
    type: integer
    description: "Grade level (9/10/11/12)"
    example: 11
    nullable: true
    validation: "IN (9, 10, 11, 12)"

  age:
    type: integer
    description: "Age at time of season"
    example: 17
    nullable: true

  # ---------------------------------------------------------------------------
  # Calculated/Derived Stats
  # ---------------------------------------------------------------------------

  field_goal_percentage:
    type: float
    description: "FG% (calculated: FGM / FGA)"
    example: 0.536
    nullable: true
    validation: ">= 0 AND <= 1"

  three_point_percentage:
    type: float
    description: "3P% (calculated: 3PM / 3PA)"
    example: 0.350
    nullable: true
    validation: ">= 0 AND <= 1"

  free_throw_percentage:
    type: float
    description: "FT% (calculated: FTM / FTA)"
    example: 0.773
    nullable: true
    validation: ">= 0 AND <= 1"

  # Per-Game Averages (if source provides totals)
  points_per_game:
    type: float
    description: "PPG (calculated if source provides totals)"
    example: 23.7
    nullable: true
    validation: ">= 0"

  rebounds_per_game:
    type: float
    description: "RPG"
    example: 10.0
    nullable: true
    validation: ">= 0"

  assists_per_game:
    type: float
    description: "APG"
    example: 4.0
    nullable: true
    validation: ">= 0"

  steals_per_game:
    type: float
    description: "SPG"
    example: 1.9
    nullable: true

  blocks_per_game:
    type: float
    description: "BPG"
    example: 1.6
    nullable: true

  minutes_per_game:
    type: float
    description: "MPG"
    example: 30.0
    nullable: true

  # Advanced Stats (if available)
  true_shooting_percentage:
    type: float
    description: "TS% = PTS / (2 * (FGA + 0.44 * FTA))"
    example: 0.589
    nullable: true

  effective_field_goal_percentage:
    type: float
    description: "eFG% = (FGM + 0.5 * 3PM) / FGA"
    example: 0.611
    nullable: true

  assist_to_turnover_ratio:
    type: float
    description: "AST/TO ratio"
    example: 1.29
    nullable: true

  # ---------------------------------------------------------------------------
  # Metadata Fields
  # ---------------------------------------------------------------------------

  per_game_stats:
    type: boolean
    description: "Flag: true if stats are per-game averages, false if totals"
    example: false
    default: false
    notes: "Most sources provide totals; some (EYBL) provide averages"

  data_quality_flag:
    type: string
    description: "Data quality assessment"
    example: "COMPLETE"
    allowed_values: ["COMPLETE", "PARTIAL", "ESTIMATED", "UNOFFICIAL"]
    default: "COMPLETE"

  source_url:
    type: string
    description: "Original URL where stats were scraped"
    example: "https://nikeeyb.com/cumulative-season-stats?season=2024"
    nullable: true

  scraped_at:
    type: datetime
    description: "Timestamp when data was scraped (ISO 8601)"
    example: "2025-11-16T23:45:00Z"
    nullable: true

  notes:
    type: string
    description: "Any additional notes about this player-season"
    example: "MVP of EYBL Peach Jam"
    nullable: true

# ==============================================================================
# VALIDATION RULES
# ==============================================================================

validation_rules:
  # Logical constraints
  - name: "shooting_sanity"
    rule: "field_goals_made <= field_goals_attempted"
    severity: "ERROR"

  - name: "three_point_sanity"
    rule: "three_pointers_made <= three_pointers_attempted"
    severity: "ERROR"

  - name: "free_throw_sanity"
    rule: "free_throws_made <= free_throws_attempted"
    severity: "ERROR"

  - name: "three_pointers_subset"
    rule: "three_pointers_made <= field_goals_made"
    severity: "WARNING"
    notes: "3PM should be subset of FGM, but some sources may not track this"

  - name: "rebounds_sum"
    rule: "IF offensive_rebounds AND defensive_rebounds THEN total_rebounds = offensive_rebounds + defensive_rebounds"
    severity: "WARNING"

  - name: "games_started_sanity"
    rule: "games_started <= games_played"
    severity: "ERROR"

  - name: "positive_games"
    rule: "games_played >= 0"
    severity: "ERROR"

  - name: "reasonable_ppg"
    rule: "IF points_per_game THEN points_per_game < 100"
    severity: "WARNING"
    notes: "Flag outliers for manual review (scoring 100 PPG is unrealistic)"

  - name: "percentage_bounds"
    rule: "field_goal_percentage BETWEEN 0 AND 1"
    severity: "ERROR"

# ==============================================================================
# COMPOSITE KEYS
# ==============================================================================

primary_key:
  - source
  - source_player_id
  - season

unique_constraints:
  - name: "player_season_unique"
    fields: [source, source_player_id, season]
    description: "Each player can have only one season record per source"

# ==============================================================================
# INDEXES (for DuckDB)
# ==============================================================================

recommended_indexes:
  - fields: [source]
    description: "Filter by datasource"

  - fields: [season]
    description: "Filter by season"

  - fields: [state_code, season]
    description: "State-level coverage queries"

  - fields: [league, season]
    description: "Circuit-level queries (EYBL, FIBA, etc.)"

  - fields: [graduation_year]
    description: "Recruiting class queries"

  - fields: [global_player_id, season]
    description: "Player career timeline"

# ==============================================================================
# USAGE NOTES
# ==============================================================================

usage_notes: |
  1. **Nullability Philosophy**:
     - Required fields (identifiers, core stats) should NEVER be null
     - Optional fields (height, position, advanced stats) can be null
     - For numeric stats, prefer 0 over null if stat wasn't recorded

  2. **Per-Game vs Totals**:
     - Most sources provide season totals (games_played=18, points=427)
     - Some (EYBL) provide averages (games_played=18, points_per_game=23.7)
     - Use `per_game_stats` flag to indicate which format
     - Downstream can calculate averages/totals as needed

  3. **Entity Resolution**:
     - Initially, global_player_id = source_player_id
     - Separate entity resolution process will merge players across sources
     - After resolution, global_player_id links same player across EYBL/SBLive/etc.

  4. **Graduated Stats**:
     - If source provides FG% but not FGM/FGA, store FG% in field_goal_percentage
     - Prefer storing raw counts (FGM/FGA) over percentages when available

  5. **Missing Stats**:
     - If source doesn't track a stat (e.g., no OREB/DREB split), leave as null
     - Don't fabricate data or estimate
     - Use data_quality_flag to indicate partial coverage

# ==============================================================================
# VERSION HISTORY
# ==============================================================================

version_history:
  - version: "1.0"
    date: "2025-11-16"
    changes: "Initial schema definition based on EYBL, SBLive, OSBA coverage"
    author: "Phase 16 - First HS Player-Season Exports"

# ==============================================================================
# EXAMPLE RECORDS
# ==============================================================================

examples:
  - description: "EYBL player (per-game stats)"
    record:
      global_player_id: "eybl_cooper_flagg"
      source: "eybl"
      source_player_id: "eybl_cooper_flagg"
      season: "2024"
      first_name: "Cooper"
      last_name: "Flagg"
      full_name: "Cooper Flagg"
      league: "Nike EYBL"
      team_id: "eybl_team_maine_united"
      team_name: "Maine United"
      state_code: "ME"
      country_code: "US"
      games_played: 18
      games_started: 18
      minutes: null
      field_goals_made: null
      field_goals_attempted: null
      three_pointers_made: null
      three_pointers_attempted: null
      free_throws_made: null
      free_throws_attempted: null
      offensive_rebounds: null
      defensive_rebounds: null
      total_rebounds: null
      assists: null
      steals: null
      blocks: null
      turnovers: null
      personal_fouls: null
      points: null
      position: "SF"
      graduation_year: 2025
      grade: 12
      field_goal_percentage: 0.536
      three_point_percentage: 0.350
      free_throw_percentage: 0.773
      points_per_game: 23.7
      rebounds_per_game: 10.0
      assists_per_game: 4.0
      steals_per_game: 1.9
      blocks_per_game: 1.6
      per_game_stats: true
      data_quality_flag: "COMPLETE"
      source_url: "https://nikeeyb.com/cumulative-season-stats?season=2024"
      scraped_at: "2025-11-16T23:45:00Z"

  - description: "SBLive player (season totals)"
    record:
      global_player_id: "sblive_wa_john_doe"
      source: "sblive"
      source_player_id: "sblive_wa_john_doe"
      season: "2024-25"
      first_name: "John"
      last_name: "Doe"
      full_name: "John Doe"
      league: "SBLive Washington"
      team_id: "sblive_wa_team_garfield"
      team_name: "Garfield High School"
      state_code: "WA"
      country_code: "US"
      games_played: 28
      games_started: 28
      minutes: 840.0
      field_goals_made: 195
      field_goals_attempted: 380
      three_pointers_made: 58
      three_pointers_attempted: 165
      free_throws_made: 102
      free_throws_attempted: 130
      offensive_rebounds: 45
      defensive_rebounds: 135
      total_rebounds: 180
      assists: 112
      steals: 42
      blocks: 18
      turnovers: 68
      personal_fouls: 56
      points: 550
      position: "PG"
      graduation_year: 2025
      grade: 12
      field_goal_percentage: 0.513
      three_point_percentage: 0.352
      free_throw_percentage: 0.785
      points_per_game: 19.6
      rebounds_per_game: 6.4
      assists_per_game: 4.0
      per_game_stats: false
      data_quality_flag: "COMPLETE"
      source_url: "https://wa.sblive.com/high-school/boys-basketball/stats"
      scraped_at: "2025-11-16T23:50:00Z"
